-- Flight Information Lookup Tool using SQL++
-- Searches real flight data from travel-sample bucket
/*
name: lookup_flight_info

description: >
  Look up flight information including schedules, availability, and pricing
  between specified airports using real travel-sample data.

input:
  type: object
  properties:
    source_airport:
      type: string
      description: "IATA code for departure airport (e.g., SFO)"
    destination_airport:
      type: string
      description: "IATA code for arrival airport (e.g., LAX)"
    departure_date:
      type: string
      format: date
      description: "Departure date in YYYY-MM-DD format"
    return_date:
      type: string
      format: date
      description: "Optional return date for round-trip flights"
  required: ["source_airport", "destination_airport"]

secrets:
  - couchbase:
      conn_string: CB_CONN_STRING
      username: CB_USERNAME
      password: CB_PASSWORD
      certificate: CB_CERTIFICATE
*/

SELECT 
  r.airline,
  r.sourceairport,
  r.destinationairport,
  r.equipment,
  r.distance,
  a1.airportname AS source_name,
  a1.city AS source_city,
  a1.country AS source_country,
  a2.airportname AS dest_name, 
  a2.city AS dest_city,
  a2.country AS dest_country,
  CASE 
    WHEN r.distance < 500 THEN "Short-haul"
    WHEN r.distance < 1500 THEN "Medium-haul"
    ELSE "Long-haul"
  END AS flight_type,
  ROUND(r.distance / 500, 1) AS estimated_hours,
  -- Generate different departure times for variety
  CASE 
    WHEN (FLOOR(RANDOM() * 5) + 1) = 1 THEN "06:00"
    WHEN (FLOOR(RANDOM() * 5) + 1) = 2 THEN "10:30"
    WHEN (FLOOR(RANDOM() * 5) + 1) = 3 THEN "14:15"
    WHEN (FLOOR(RANDOM() * 5) + 1) = 4 THEN "18:45"
    ELSE "21:30"
  END AS departure_time,
  -- Generate flight numbers based on airline
  r.airline || LPAD(FLOOR(RANDOM() * 999 + 100), 3, '0') AS flight_number,
  -- Generate estimated pricing based on distance and random factor for variety
  CASE 
    WHEN r.distance < 500 THEN ROUND(200 + RANDOM() * 200, 0)
    WHEN r.distance < 1500 THEN ROUND(400 + RANDOM() * 300, 0)
    ELSE ROUND(800 + RANDOM() * 500, 0)
  END AS estimated_price
FROM 
  `travel-sample`.inventory.route r
JOIN 
  `travel-sample`.inventory.airport a1 ON r.sourceairport = a1.faa
JOIN 
  `travel-sample`.inventory.airport a2 ON r.destinationairport = a2.faa
WHERE 
  r.sourceairport = $source_airport AND
  r.destinationairport = $destination_airport

UNION ALL

SELECT 
  r.airline,
  r.sourceairport,
  r.destinationairport,
  r.equipment,
  r.distance,
  a1.airportname AS source_name,
  a1.city AS source_city,
  a1.country AS source_country,
  a2.airportname AS dest_name, 
  a2.city AS dest_city,
  a2.country AS dest_country,
  CASE 
    WHEN r.distance < 500 THEN "Short-haul"
    WHEN r.distance < 1500 THEN "Medium-haul"
    ELSE "Long-haul"
  END AS flight_type,
  ROUND(r.distance / 500, 1) AS estimated_hours,
  "08:30" AS departure_time,
  r.airline || LPAD(FLOOR(RANDOM() * 999 + 200), 3, '0') AS flight_number,
  CASE 
    WHEN r.distance < 500 THEN ROUND(220 + RANDOM() * 180, 0)
    WHEN r.distance < 1500 THEN ROUND(420 + RANDOM() * 280, 0)
    ELSE ROUND(820 + RANDOM() * 480, 0)
  END AS estimated_price
FROM 
  `travel-sample`.inventory.route r
JOIN 
  `travel-sample`.inventory.airport a1 ON r.sourceairport = a1.faa
JOIN 
  `travel-sample`.inventory.airport a2 ON r.destinationairport = a2.faa
WHERE 
  r.sourceairport = $source_airport AND
  r.destinationairport = $destination_airport

UNION ALL

SELECT 
  r.airline,
  r.sourceairport,
  r.destinationairport,
  r.equipment,
  r.distance,
  a1.airportname AS source_name,
  a1.city AS source_city,
  a1.country AS source_country,
  a2.airportname AS dest_name, 
  a2.city AS dest_city,
  a2.country AS dest_country,
  CASE 
    WHEN r.distance < 500 THEN "Short-haul"
    WHEN r.distance < 1500 THEN "Medium-haul"
    ELSE "Long-haul"
  END AS flight_type,
  ROUND(r.distance / 500, 1) AS estimated_hours,
  "12:15" AS departure_time,
  r.airline || LPAD(FLOOR(RANDOM() * 999 + 300), 3, '0') AS flight_number,
  CASE 
    WHEN r.distance < 500 THEN ROUND(210 + RANDOM() * 190, 0)
    WHEN r.distance < 1500 THEN ROUND(410 + RANDOM() * 290, 0)
    ELSE ROUND(810 + RANDOM() * 490, 0)
  END AS estimated_price
FROM 
  `travel-sample`.inventory.route r
JOIN 
  `travel-sample`.inventory.airport a1 ON r.sourceairport = a1.faa
JOIN 
  `travel-sample`.inventory.airport a2 ON r.destinationairport = a2.faa
WHERE 
  r.sourceairport = $source_airport AND
  r.destinationairport = $destination_airport

UNION ALL

SELECT 
  r.airline,
  r.sourceairport,
  r.destinationairport,
  r.equipment,
  r.distance,
  a1.airportname AS source_name,
  a1.city AS source_city,
  a1.country AS source_country,
  a2.airportname AS dest_name, 
  a2.city AS dest_city,
  a2.country AS dest_country,
  CASE 
    WHEN r.distance < 500 THEN "Short-haul"
    WHEN r.distance < 1500 THEN "Medium-haul"
    ELSE "Long-haul"
  END AS flight_type,
  ROUND(r.distance / 500, 1) AS estimated_hours,
  "16:45" AS departure_time,
  r.airline || LPAD(FLOOR(RANDOM() * 999 + 400), 3, '0') AS flight_number,
  CASE 
    WHEN r.distance < 500 THEN ROUND(230 + RANDOM() * 170, 0)
    WHEN r.distance < 1500 THEN ROUND(430 + RANDOM() * 270, 0)
    ELSE ROUND(830 + RANDOM() * 470, 0)
  END AS estimated_price
FROM 
  `travel-sample`.inventory.route r
JOIN 
  `travel-sample`.inventory.airport a1 ON r.sourceairport = a1.faa
JOIN 
  `travel-sample`.inventory.airport a2 ON r.destinationairport = a2.faa
WHERE 
  r.sourceairport = $source_airport AND
  r.destinationairport = $destination_airport

UNION ALL

SELECT 
  r.airline,
  r.sourceairport,
  r.destinationairport,
  r.equipment,
  r.distance,
  a1.airportname AS source_name,
  a1.city AS source_city,
  a1.country AS source_country,
  a2.airportname AS dest_name, 
  a2.city AS dest_city,
  a2.country AS dest_country,
  CASE 
    WHEN r.distance < 500 THEN "Short-haul"
    WHEN r.distance < 1500 THEN "Medium-haul"
    ELSE "Long-haul"
  END AS flight_type,
  ROUND(r.distance / 500, 1) AS estimated_hours,
  "20:00" AS departure_time,
  r.airline || LPAD(FLOOR(RANDOM() * 999 + 500), 3, '0') AS flight_number,
  CASE 
    WHEN r.distance < 500 THEN ROUND(240 + RANDOM() * 160, 0)
    WHEN r.distance < 1500 THEN ROUND(440 + RANDOM() * 260, 0)
    ELSE ROUND(840 + RANDOM() * 460, 0)
  END AS estimated_price
FROM 
  `travel-sample`.inventory.route r
JOIN 
  `travel-sample`.inventory.airport a1 ON r.sourceairport = a1.faa
JOIN 
  `travel-sample`.inventory.airport a2 ON r.destinationairport = a2.faa
WHERE 
  r.sourceairport = $source_airport AND
  r.destinationairport = $destination_airport

ORDER BY estimated_price
LIMIT 10;