-- Flight Information Lookup Tool using SQL++
-- Searches real flight data from travel-sample bucket
/*
name: lookup_flight_info

description: >
  Look up flight information including schedules, availability, and pricing
  between specified airports using real travel-sample data.

input:
  type: object
  properties:
    source_airport:
      type: string
      description: "IATA code for departure airport (e.g., SFO)"
    destination_airport:
      type: string
      description: "IATA code for arrival airport (e.g., LAX)"
    departure_date:
      type: string
      format: date
      description: "Departure date in YYYY-MM-DD format"
    return_date:
      type: string
      format: date
      description: "Optional return date for round-trip flights"
  required: ["source_airport", "destination_airport"]

secrets:
  - couchbase:
      conn_string: CB_CONN_STRING
      username: CB_USERNAME
      password: CB_PASSWORD
      certificate: CB_CERTIFICATE
*/

SELECT 
  r.airline,
  r.sourceairport,
  r.destinationairport,
  r.equipment,
  r.distance,
  a1.airportname AS source_name,
  a1.city AS source_city,
  a1.country AS source_country,
  a2.airportname AS dest_name, 
  a2.city AS dest_city,
  a2.country AS dest_country,
  CASE 
    WHEN r.distance < 500 THEN "Short-haul"
    WHEN r.distance < 1500 THEN "Medium-haul"
    ELSE "Long-haul"
  END AS flight_type,
  ROUND(r.distance / 500, 1) AS estimated_hours,
  -- Generate deterministic departure times based on airline
  CASE 
    WHEN r.airline = 'AA' THEN "06:00"
    WHEN r.airline = 'DL' THEN "08:30"
    WHEN r.airline = 'UA' THEN "12:15"
    WHEN r.airline = 'US' THEN "16:45"
    WHEN r.airline = 'AF' THEN "20:00"
    WHEN r.airline = 'KL' THEN "10:30"
    WHEN r.airline = 'AS' THEN "14:00"
    WHEN r.airline = 'B6' THEN "15:30"
    WHEN r.airline = 'VX' THEN "17:00"
    WHEN r.airline = 'WN' THEN "19:15"
    ELSE "11:45"
  END AS departure_time,
  -- Generate flight numbers based on airline  
  r.airline || CASE 
    WHEN r.airline = 'AA' THEN "123"
    WHEN r.airline = 'DL' THEN "223"
    WHEN r.airline = 'UA' THEN "323"
    WHEN r.airline = 'US' THEN "423"
    WHEN r.airline = 'AF' THEN "523"
    WHEN r.airline = 'KL' THEN "623"
    WHEN r.airline = 'AS' THEN "723"
    WHEN r.airline = 'B6' THEN "823"
    WHEN r.airline = 'VX' THEN "923"
    WHEN r.airline = 'WN' THEN "103"
    ELSE "999"
  END AS flight_number,
  -- Generate deterministic pricing based on distance and airline
  CASE 
    WHEN r.distance < 500 THEN 200 + CASE 
      WHEN r.airline = 'AA' THEN 20
      WHEN r.airline = 'DL' THEN 40
      WHEN r.airline = 'UA' THEN 60
      WHEN r.airline = 'US' THEN 80
      WHEN r.airline = 'AF' THEN 100
      WHEN r.airline = 'KL' THEN 120
      ELSE 30
    END
    WHEN r.distance < 1500 THEN 400 + CASE 
      WHEN r.airline = 'AA' THEN 30
      WHEN r.airline = 'DL' THEN 60
      WHEN r.airline = 'UA' THEN 90
      WHEN r.airline = 'US' THEN 120
      WHEN r.airline = 'AF' THEN 150
      WHEN r.airline = 'KL' THEN 180
      ELSE 45
    END
    ELSE 800 + CASE 
      WHEN r.airline = 'AA' THEN 50
      WHEN r.airline = 'DL' THEN 100
      WHEN r.airline = 'UA' THEN 150
      WHEN r.airline = 'US' THEN 200
      WHEN r.airline = 'AF' THEN 250
      WHEN r.airline = 'KL' THEN 300
      ELSE 75
    END
  END AS estimated_price
FROM 
  `travel-sample`.inventory.route r
JOIN 
  `travel-sample`.inventory.airport a1 ON r.sourceairport = a1.faa
JOIN 
  `travel-sample`.inventory.airport a2 ON r.destinationairport = a2.faa
WHERE 
  r.sourceairport = $source_airport AND
  r.destinationairport = $destination_airport

UNION ALL

SELECT 
  r.airline,
  r.sourceairport,
  r.destinationairport,
  r.equipment,
  r.distance,
  a1.airportname AS source_name,
  a1.city AS source_city,
  a1.country AS source_country,
  a2.airportname AS dest_name, 
  a2.city AS dest_city,
  a2.country AS dest_country,
  CASE 
    WHEN r.distance < 500 THEN "Short-haul"
    WHEN r.distance < 1500 THEN "Medium-haul"
    ELSE "Long-haul"
  END AS flight_type,
  ROUND(r.distance / 500, 1) AS estimated_hours,
  -- Different departure times for variety
  CASE 
    WHEN r.airline = 'AA' THEN "18:15"
    WHEN r.airline = 'DL' THEN "21:30"
    WHEN r.airline = 'UA' THEN "07:45"
    WHEN r.airline = 'US' THEN "11:00"
    WHEN r.airline = 'AF' THEN "15:30"
    WHEN r.airline = 'KL' THEN "19:45"
    WHEN r.airline = 'AS' THEN "13:15"
    WHEN r.airline = 'B6' THEN "16:00"
    WHEN r.airline = 'VX' THEN "09:30"
    WHEN r.airline = 'WN' THEN "22:00"
    ELSE "14:30"
  END AS departure_time,
  -- Different flight numbers
  r.airline || CASE 
    WHEN r.airline = 'AA' THEN "456"
    WHEN r.airline = 'DL' THEN "556"
    WHEN r.airline = 'UA' THEN "656"
    WHEN r.airline = 'US' THEN "756"
    WHEN r.airline = 'AF' THEN "856"
    WHEN r.airline = 'KL' THEN "956"
    WHEN r.airline = 'AS' THEN "156"
    WHEN r.airline = 'B6' THEN "256"
    WHEN r.airline = 'VX' THEN "356"
    WHEN r.airline = 'WN' THEN "789"
    ELSE "888"
  END AS flight_number,
  -- Slightly different pricing
  CASE 
    WHEN r.distance < 500 THEN 220 + CASE 
      WHEN r.airline = 'AA' THEN 15
      WHEN r.airline = 'DL' THEN 35
      WHEN r.airline = 'UA' THEN 55
      WHEN r.airline = 'US' THEN 75
      WHEN r.airline = 'AF' THEN 95
      WHEN r.airline = 'KL' THEN 115
      ELSE 25
    END
    WHEN r.distance < 1500 THEN 420 + CASE 
      WHEN r.airline = 'AA' THEN 25
      WHEN r.airline = 'DL' THEN 55
      WHEN r.airline = 'UA' THEN 85
      WHEN r.airline = 'US' THEN 115
      WHEN r.airline = 'AF' THEN 145
      WHEN r.airline = 'KL' THEN 175
      ELSE 40
    END
    ELSE 820 + CASE 
      WHEN r.airline = 'AA' THEN 45
      WHEN r.airline = 'DL' THEN 95
      WHEN r.airline = 'UA' THEN 145
      WHEN r.airline = 'US' THEN 195
      WHEN r.airline = 'AF' THEN 245
      WHEN r.airline = 'KL' THEN 295
      ELSE 70
    END
  END AS estimated_price
FROM 
  `travel-sample`.inventory.route r
JOIN 
  `travel-sample`.inventory.airport a1 ON r.sourceairport = a1.faa
JOIN 
  `travel-sample`.inventory.airport a2 ON r.destinationairport = a2.faa
WHERE 
  r.sourceairport = $source_airport AND
  r.destinationairport = $destination_airport

ORDER BY estimated_price
LIMIT 10;